# Отчет по БД

- Вид работы: Лабораторная работа
- Предмет: Базы данных (теоретические основы баз данных)
- Студент группы Б20-514: Шенягин Даниил

# 1. Предметная область
В качестве предметной области было выбрано интернет-энциклопедия Википедия.
Википе́дия (англ. Wikipedia, произносится [ˌwɪkɨˈpiːdiə] или [ˌwɪkiˈpiːdiə]) — общедоступная многоязычная универсальная интернет-энциклопедия со свободным контентом, реализованная на принципах вики.

## Модель данных:

## Сущности:

### Статья
Атрибуты:
- id – PK
- type – string – тип статьи
- section – FK – хранит id секции, в которой содержится статья
- search_indexed – bool – флаг для индексации поисковыми запросами

### Переводы
Атрибуты:
- article_id – FK – id статьи для перевода на исходные язык
- title – string – локализированное заголовок 
- short_description – string – локализированное описание
- data – string - локализированные данные (содержание статьи)
- lang – FK – id языка, на который переведена статья
- views - int - количество просмотров

### Языки
Атрибуты:
- id – PK
- name – string – название языка


### Секции
Атрибуты:
- id – PK
- name – string – название секции
- section_outer_id – number – ссылка на секцию выше, если она самая «верхняя», то здесь null
- level – number – вспомогательная колонка для хранения позиции секции

### История
Атрибуты:
- id – PK
- change_at – date – когда было изменение
- change_by – FK – кем было совершено изменение
- type – string [“created”, “updated”, “deleted”] – тип изменения
- translation_id – FK
- contribution – number – вклад


### Пользователь
Атрибуты:
- id – PK 
- display_name – string – отображаемое имя
- email – string
- login – string
- password_hash – string
- group – FK (UserRoles.id)
- created_at – date – когда создан аккаунт
- updated_at – date – дата последнего изменения



### Группы доступов
Атрибуты:
- id – PK
- section  - FK (sections.id) – секция, на которую распространяются права
- all_sections – bool – флаг, означающий, что права распространяются на все секции
- name – string – название группы
- right_create – Boolean – права для создания статьи
- right_read – Boolean – права для создания статьи
- right_update – Boolean – права для создания статьи
- right_delete – Boolean – права для создания статьи
- right_publish – Boolean – права для создания статьи
- right_review – Boolean – права для создания статьи


### Шаблоны
Атрибуты:
- id – PK
- type – string – тип статьи
- section – FK – хранит id секции, в которой содержится статья
- search_indexed – bool – флаг для индексации поисковыми запросами


# 2. Физическая модель

![alt text](https://raw.githubusercontent.com/daniil00t/db_course_5sem/main/assets/images/schema_init.png)

# 3.Создание таблиц базы данных

## 3.1.	Sections

```sql
create table sections (
  id serial primary key,
  name text not null default 'no_name' check (length(name) < 200),
  section_outer_id integer default null,
  level integer not null default 1 check (level > 0)
);
```
## 3.2.	Articles

```sql
create table articles (
	id serial primary key,
	type text not null check (type in ('default', 'official', 'private', 'internal')),
	section integer not null,
	search_indexed boolean not null,
	constraint "articles_to_section" 
		foreign key ("section") 
		references "sections"("id")
);
```

## 3.3.	Groups

```sql
create table "groups" (
	id serial primary key,
	name text not null check (length(name) < 200),
	section integer,
	all_sections boolean not null default false,
	right_create boolean not null default false,
	right_read boolean not null default false,
	right_update boolean not null default false,
	right_delete boolean not null default false,
	right_publish boolean not null default false,
	right_review boolean not null default false,
	constraint "groups_to_section" 
		foreign key ("section") 
		references "sections"("id")
);
```
## 3.4.	Users

```sql
create table users (
	id serial primary key,
	display_name text not null check(length(display_name) < 200),
	email text not null check(length(email) < 1000),
	login text not null check(length(login) < 1000),
	password_hash text not null check(length(password_hash) < 100),
	group_id integer not null,
	created_at timestamp not null check(created_at > '2022-12-01'),
	updated_at timestamp not null check(updated_at > '2022-12-01'),
	constraint "users_to_group" 
		foreign key ("group_id") 
		references "groups"("id")
);
```
## 3.5.	History

```sql
create table history (
	id serial primary key,
	change_at timestamp not null check(change_at > '2022-12-01'),
	change_by integer not null,
	type text not null check (type in ('create', 'update', 'delete')),
	translation_id integer not null,
	contribution integer not null default 0 check (contribution >= 0),
	constraint "history_to_users" 
		foreign key ("change_by") 
		references "users"("id"),
	constraint "history_to_translation" 
		foreign key ("translation_id") 
		references "translations"("id")
);
```
## 3.6.	Watchers

```sql
create table watchers (
	user_id integer not null,
	article_id integer not null,
	start_watch_date timestamp not null check (start_watch_date > '2022-12-01'),
	constraint "watchers_to_user" 
		foreign key ("user_id") 
		references "users"("id"),
	constraint "watchers_to_article" 
		foreign key ("article_id") 
		references "translations"("id")
);
```

## 3.7.	Translations

```sql
create table translations (
	id serial primary key,
	article_id integer not null,
	title text not null check (length(title) < 500),
	short_description text not null check (length(short_description) < 2000),
	data text not null check (length(data) < 100000),
	lang integer not null,
	byte_length integer not null,
	first_source boolean not null default false,
	views integer not null check (views >= 0),
	constraint "translatations_to_article" 
		foreign key ("article_id") 
		references "articles"("id"),
	constraint "translatations_language" 
		foreign key ("lang") 
		references "languages"("id")
);
```

## 3.8.	Templates

```sql
create table templates (
	id serial primary key,
	name text not null check (length(name) < 100),
	data text not null default '<DefaultTemplate>$0</DefaultTemplate>' check (length(data) < 100000)
);
```


# 4. Заполнение базы данных
> Для заполнению данных использовался язык программирования Python, подключение к базе данных PostgreSQL осуществлялось с помощью библиотеки > psycopg2. Для генерации данных использовалась библиотека Faker. 

> Ниже прилагаю код создания каждой из таблиц.

## 4.1.	connector.py -> init connect
Создание соединения к базе постгре

```python
import psycopg2

conn = psycopg2.connect(
    host="localhost",
    database="postgres",
    user="d.shenyagin",
    password="")

cur = conn.cursor()
```

## 4.2.	articles.py -> articles

```python
from connector import *
from faker import Faker
import random

fake = Faker()

#      Column     |  Type   | Collation | Nullable |               Default                
# ----------------+---------+-----------+----------+--------------------------------------
#  id             | integer |           | not null | nextval('articles_id_seq'::regclass)
#  type           | text    |           | not null | 
#  section        | integer |           | not null | 
#  search_indexed | boolean |           | not null | 
#  views          | integer |           | not null | 

types = ['default', 'official', 'private', 'internal']

def main():
  for i in range(10000):
    row = (types[random.randint(0, 3)], random.randint(1, 2000), random.random() > 0.5, random.randint(1, 10000))
    cur.execute('insert into articles (type, section, search_indexed, views) values (%s, %s, %s, %s);', row)

  conn.commit()

main()
```

## 4.3.	groups.py -> groups

```python
from connector import *
from faker import Faker
import random

fake = Faker()

#     Column     |  Type   | Collation | Nullable |              Default               
# ---------------+---------+-----------+----------+------------------------------------
#  id            | integer |           | not null | nextval('groups_id_seq'::regclass)
#  name          | text    |           | not null | 
#  section       | integer |           | not null | 
#  all_sections  | boolean |           | not null | false
#  right_create  | boolean |           | not null | false
#  right_read    | boolean |           | not null | false
#  right_update  | boolean |           | not null | false
#  right_delete  | boolean |           | not null | false
#  right_publish | boolean |           | not null | false
#  right_review  | boolean |           | not null | false

def addFill(binary, n):
  if(len(binary) == n):
    return binary
  return '0' * (n - len(binary)) + binary

def main():
  n = 6
  for i in range(2 ** n):
    binary = addFill(bin(i)[2:], n)
    (right_create, right_read, right_update, right_delete, right_publish, right_review) = binary
    row = (fake.word(), None, False, bool(int(right_create)), bool(int(right_read)), bool(int(right_update)), bool(int(right_delete)), bool(int(right_publish)), bool(int(right_review)))
    cur.execute('insert into groups (name, section, all_sections, right_create, right_read, right_update, right_delete, right_publish, right_review) values (%s, %s, %s, %s, %s, %s, %s, %s, %s);', row)

  conn.commit()

main()
```

## 4.4.	history.py -> history

```python
from connector import *
from faker import Faker
import random
from datetime import datetime

fake = Faker()

#     Column    |            Type             | Collation | Nullable |               Default               
# --------------+-----------------------------+-----------+----------+-------------------------------------
#  id           | integer                     |           | not null | nextval('history_id_seq'::regclass)
#  change_at    | timestamp without time zone |           | not null | 
#  change_by    | integer                     |           | not null | 
#  type         | text                        |           | not null | 
#  article_id   | integer                     |           | not null | 
#  contribution | integer                     |           | not null | 0

types = ['create', 'update', 'delete']

def main():
  for i in range(100000):
    default = datetime.strptime('2022-12-02T00:00:00', '%Y-%m-%dT%H:%M:%S')
    now = datetime.now()
    change_at = fake.date_time_between(default, now)

    row = (change_at, random.randint(1, 10000), types[random.randint(0, 2)], random.randint(1, 99999), random.randint(1, 150))
    cur.execute('insert into history (change_at, change_by, type, translation_id, contribution) values (%s, %s, %s, %s, %s);', row)

  conn.commit()

main()
```

## 4.5.	languages.py -> languages

```python
from connector import *
from faker import Faker
import pycountry

fake = Faker()

#  Column |  Type   | Collation | Nullable |                Default                
# --------+---------+-----------+----------+---------------------------------------
#  id     | integer |           | not null | nextval('languages_id_seq'::regclass)
#  name   | text    |           | not null | 

def main():
  for i in [country.alpha_2 for country in pycountry.countries]:
    cur.execute('insert into languages (name) values (%s);', [i])

  conn.commit()

main()
```

## 4.6.	sections.py -> sections

```python
from connector import *
from faker import Faker
import random

fake = Faker()

#       Column      |  Type   | Collation | Nullable |               Default                
# ------------------+---------+-----------+----------+--------------------------------------
#  id               | integer |           | not null | nextval('sections_id_seq'::regclass)
#  name             | text    |           | not null | 'no_name'::text
#  section_outer_id | integer |           |          | 
#  level            | integer |           | not null | 1


def commit_independent():
  for i in range(500):
    row = (fake.word(), None, 1)
    cur.execute('insert into sections (name, section_outer_id, level) values (%s, %s, %s);', row)

  conn.commit()

def commit_dependent():
  for i in range(2, 5):
    for j in range(500):
      row = (fake.word(), random.randint(500 * (i - 2) + 1, 500 * (i - 1)), i)
      cur.execute('insert into sections (name, section_outer_id, level) values (%s, %s, %s);', row)

  conn.commit()

commit_independent()
commit_dependent()
```

## 4.6.	templates.py -> templates
```python
from connector import *
from faker import Faker

fake = Faker()

#  Column |  Type   | Collation | Nullable |                    Default                    
# --------+---------+-----------+----------+-----------------------------------------------
#  id     | integer |           | not null | nextval('templates_id_seq'::regclass)
#  name   | text    |           | not null | 
#  data   | text    |           | not null | '<DefaultTemplate>$0</DefaultTemplate>'::text

def main():
  for i in range(100):
    name = "_".join(fake.words(nb=3))
    row = (name, f"<{name}>$0</{name}>")
    cur.execute('insert into templates (name, data) values (%s, %s);', row)

  conn.commit()

main()
```

## 4.7.	translations.py -> translations
```python
from connector import *
from faker import Faker
import random

fake = Faker()

#       Column       |  Type   | Collation | Nullable | Default 
# -------------------+---------+-----------+----------+---------
#  article_id        | integer |           | not null | 
#  title             | text    |           | not null | 
#  short_description | text    |           | not null | 
#  data              | text    |           | not null | 
#  lang              | integer |           | not null | 
#  byte_length       | integer |           | not null | 
#  first_source      | boolean |           | not null | false

def main():
  # сначала заполняем для каждой целевой статьи, чтобы у нее был как минимум один перевод
  for i in range(1, 10000):
    title = fake.sentence(nb_words=6, variable_nb_words=False)
    short_description = fake.paragraph(nb_sentences=5)
    data = f"<DefaultTemplate>{fake.paragraph(nb_sentences=30)}</DefaultTemplate>"
    lang = random.randint(1, 249)
    byte_length = len(data) * 8
    first_source = True
    views = random.randint(1, 100000)
    row = (i, title, short_description, data, lang, byte_length, first_source, views)
    
    cur.execute('insert into translations (article_id, title, short_description, data, lang, byte_length, first_source, views) values (%s, %s, %s, %s, %s, %s, %s, %s);', row)


  for i in range(90000):
    title = fake.sentence(nb_words=6, variable_nb_words=False)
    short_description = fake.paragraph(nb_sentences=5)
    data = f"<DefaultTemplate>{fake.paragraph(nb_sentences=30)}</DefaultTemplate>"
    lang = random.randint(1, 249)
    byte_length = len(data) * 8
    first_source = False
    views = random.randint(1, 100000)
    row = (random.randint(1, 10000), title, short_description, data, lang, byte_length, first_source, views)
    
    cur.execute('insert into translations (article_id, title, short_description, data, lang, byte_length, first_source, views) values (%s, %s, %s, %s, %s, %s, %s, %s);', row)

  conn.commit()

main()
```
## 4.8.	users.py -> users
```python
from connector import *
from faker import Faker
import hashlib
import random
from datetime import datetime

fake = Faker()

#     Column     |  Type   | Collation | Nullable |              Default              
# ---------------+---------+-----------+----------+-----------------------------------
#  id            | integer |           | not null | nextval('users_id_seq'::regclass)
#  display_name  | text    |           | not null | 
#  email         | text    |           | not null | 
#  login         | text    |           | not null | 
#  password_hash | text    |           | not null | 
#  group_id      | integer |           | not null | 
#  created_at    | date    |           | not null | 
#  updated_at    | date    |           | not null | 

def main():
  for i in range(10000):
    email = fake.free_email()

    password = hashlib.sha256(email.encode('utf-8')).hexdigest()

    default = datetime.strptime('2022-12-02T00:00:00', '%Y-%m-%dT%H:%M:%S')
    now = datetime.now()
    created_at = fake.date_time_between(default, now)
    updated_at = fake.date_time_between(created_at, now)

    row = (fake.name(), email, f"{fake.word()}.{email}", password, random.randint(1, 65), created_at, updated_at)
    cur.execute('insert into users (display_name, email, login, password_hash, group_id, created_at, updated_at) values (%s, %s, %s, %s, %s, %s, %s);', row)

  conn.commit()

main()
```

## 4.9.	watchers.py -> watchers
```python
from connector import *
from faker import Faker
import random
from datetime import datetime

fake = Faker()

#       Column      |            Type             | Collation | Nullable | Default 
# ------------------+-----------------------------+-----------+----------+---------
#  user_id          | integer                     |           | not null | 
#  article_id       | integer                     |           | not null | 
#  start_watch_date | timestamp without time zone |           | not null | 

def main():
  for i in range(5000):
    default = datetime.strptime('2022-12-02T00:00:00', '%Y-%m-%dT%H:%M:%S')
    now = datetime.now()
    start_watch_date = fake.date_time_between(default, now)

    row = (random.randint(1, 10000), random.randint(1, 100000), start_watch_date)

    cur.execute('insert into watchers (user_id, article_id, start_watch_date) values (%s, %s, %s);', row)

  conn.commit()

main()
```

# 5. Запросы к базе данных

## 5.1.	Вывести топ 10 пользователей по количеству вкладов индексируемых статей	

запрос:
```sql
select 
  display_name,
  login,
  email,
  sum(contribution) as contribution_sum
from users 
inner join history on users.id = history.change_by
inner join translations on history.translation_id = translations.id
inner join articles on translations.article_id = articles.id
where search_indexed = true
group by users.id
order by contribution_sum desc
LIMIT 10;
```

ответ:

| display_name text |     login text     |             email text            |   contribution_sum bigint   |      |
|:-----------------:|:------------------:|:---------------------------------:|:---------------------------:|------|
|         1         | Christopher Holmes | personal.charles82@gmail.com      | charles82@gmail.com         | 1257 |
|         2         | Olivia Byrd        | wrong.fowlerjoseph@yahoo.com      | fowlerjoseph@yahoo.com      | 1240 |
|         3         | Thomas Fry         | page.jennifer83@hotmail.com       | jennifer83@hotmail.com      | 1223 |
|         4         | Kyle Thomas        | five.vfitzgerald@gmail.com        | vfitzgerald@gmail.com       | 1185 |
|         5         | Donald Mccormick   | entire.lauren04@yahoo.com         | lauren04@yahoo.com          | 1162 |
|         6         | Melissa Nelson     | off.brandon44@hotmail.com         | brandon44@hotmail.com       | 1157 |
|         7         | Debra Brewer       | break.mcdonaldrebecca@hotmail.com | mcdonaldrebecca@hotmail.com | 1153 |
|         8         | Kevin Lawrence     | magazine.powellcarl@yahoo.com     | powellcarl@yahoo.com        | 1150 |
|         9         | Sara Smith         | choose.davidmcgee@hotmail.com     | davidmcgee@hotmail.com      | 1141 |
|         10        | Justin Beltran     | prepare.krodgers@hotmail.com      | krodgers@hotmail.com        | 1140 |


## 5.2.	Вывести 20 последних переводов статей ранжируемых по количеству просмотров и измененных позже 12 декабря 2022 года пользователем, имеющим права на изменение всех разделов

запрос:
```sql
select 
  translations.id, 
  title, 
  short_description, 
  updated_at, 
  views
from translations
inner join history on history.translation_id = translations.id
inner join users on users.id = history.change_by
inner join groups on groups.id = users.group_id
where 
  history.change_at > '2022-12-12' and
  all_sections = true
order by views desc, updated_at desc
limit 20
```

ответ:
| id integer | title text |                 short_description text                |                                                         updated_at timestamp without time zone                                                        |                       views integer                      |       |
|:----------:|:----------:|:-----------------------------------------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------:|:--------------------------------------------------------:|-------|
|      1     | 99534      | Give seven very me trade party.                       | Great language significant him dream box prepare. Something risk worker people home every draw. Star such theory land. Public front condition cost m… | Sun Dec 18 2022 02:10:12 GMT+0300 (Moscow Standard Time) | 99978 |
|      2     | 96866      | Change increase during old attack sport.              | Question every direction. Degree local political imagine prepare. Only grow local future career development general letter. Military million believe… | Sat Dec 17 2022 02:38:49 GMT+0300 (Moscow Standard Time) | 99762 |
|      3     | 4696       | Deep chance machine about city although.              | Property some enter exactly citizen. Answer note teacher president letter minute board. Daughter example outside race wall. Personal spring many the… | Sun Dec 11 2022 09:34:29 GMT+0300 (Moscow Standard Time) | 99303 |
|      4     | 52209      | Center product suffer majority full western.          | Figure once resource seem wear. Low produce family. Green east leg final specific sister. Yeah commercial heavy.                                      | Sat Dec 10 2022 21:38:41 GMT+0300 (Moscow Standard Time) | 99179 |
|      5     | 96080      | Concern total risk agent race popular.                | Food crime information candidate region. Available tell player read necessary throw year. However country find him sport her. Government parent dog … | Wed Dec 14 2022 08:58:56 GMT+0300 (Moscow Standard Time) | 99133 |
|      6     | 56804      | Per message since policy responsibility thousand.     | Technology amount true human draw. Manager concern dinner water. Own us finally performance impact environmental.                                     | Thu Dec 08 2022 23:24:17 GMT+0300 (Moscow Standard Time) | 99092 |
|      7     | 69979      | Daughter onto wear would foot close.                  | Own head good sea yet job. Represent job well. Pay president do nice room body PM.                                                                    | Sun Dec 18 2022 11:23:02 GMT+0300 (Moscow Standard Time) | 99080 |
|      8     | 69031      | Despite become especially administration else region. | Method concern seven ground page. Way let tough rate subject data under. Product politics soldier behavior draw close. Range four single happy year.… | Mon Dec 05 2022 06:40:54 GMT+0300 (Moscow Standard Time) | 98830 |
|      9     | 53361      | Seat future understand stand full customer.           | Away pull key street. Right baby author woman trade wide. Begin meeting call loss up executive. Dream service education throw account culture quite … | Sat Dec 17 2022 09:48:26 GMT+0300 (Moscow Standard Time) | 98554 |
|     10     | 77746      | Above billion condition sell ground allow.            | Lose include force science control form week. Policy view economy son. Year campaign capital common eat simply church.                                | Tue Dec 13 2022 19:17:29 GMT+0300 (Moscow Standard Time) | 98540 |
|     11     | 44368      | Development town name prepare perhaps husband.        | Property practice process experience argue consumer theory. End three discuss toward institution happen something. Door it hold past white thing con… | Sat Dec 10 2022 21:38:41 GMT+0300 (Moscow Standard Time) | 98520 |
|     12     | 60570      | Evidence manager building win serve minute.           | Discuss sea want either his conference. Brother this sort deep state tough too. Citizen series such explain one list news. Born particular same impo… | Mon Dec 05 2022 16:15:38 GMT+0300 (Moscow Standard Time) | 98412 |
|     13     | 70939      | Yes production on yes trade these.                    | Watch deep behavior show trial. Compare commercial lot west. Street leave suddenly her key anyone shake. Begin over sense participant. Inside scient… | Sun Dec 18 2022 14:19:45 GMT+0300 (Moscow Standard Time) | 98360 |
|     14     | 28298      | Beautiful growth investment history customer care.    | During occur data brother or home. Cultural kind cover job fire. Although social gas. Believe past traditional American.                              | Sat Dec 17 2022 21:48:47 GMT+0300 (Moscow Standard Time) | 98195 |
|     15     | 64307      | Its everything hit size person easy.                  | Car from study democratic pay eight. North exactly attention. Style ten do participant. Two increase west talk. Together character open last pattern… | Sat Dec 17 2022 21:32:46 GMT+0300 (Moscow Standard Time) | 98172 |
|     16     | 51695      | Project read soon old bring vote.                     | Pm do young maintain. Close test alone price daughter success. Green coach federal official live soon. Better forward fact myself ok. On time pretty… | Wed Dec 14 2022 07:46:35 GMT+0300 (Moscow Standard Time) | 97702 |
|     17     | 39320      | Forget lose decade hold couple fill.                  | Exactly think public white seem pay. Budget shake always low sign produce. However top by particularly question. Natural home produce adult few.      | Sat Dec 17 2022 22:32:27 GMT+0300 (Moscow Standard Time) | 97315 |
|     18     | 39320      | Forget lose decade hold couple fill.                  | Exactly think public white seem pay. Budget shake always low sign produce. However top by particularly question. Natural home produce adult few.      | Fri Dec 16 2022 04:11:59 GMT+0300 (Moscow Standard Time) | 97315 |
|     19     | 11697      | Blue card admit media face business.                  | Front southern per thing speak guy. Issue need wife enter forward. Trial mother interest book. Light hit development. Apply glass measure son servic… | Mon Dec 12 2022 01:16:15 GMT+0300 (Moscow Standard Time) | 97309 |
|     20     | 16140      | Agreement paper director positive people explain.     | Boy front environmental page near. Go deep easy at. Bar artist evening window. Of and surface movie. Fact along foot human skill soldier. Oil want l… | Sat Dec 10 2022 03:56:13 GMT+0300 (Moscow Standard Time) | 97062 |
---

## 5.3.	Вывести всех пользователей, которые создали хотя бы 1 статью хотя бы с половиной от среднго числа всех переводов позже 8 декабря 2022

запрос:
```sql
with counts as (
  select
    article_id,
    count(1) as total_count_translations
  from translations
  group by article_id
),
calculations as (
  select avg(total_count_translations) as avg_total_count_translations from counts
),
sorted_translations as (
  select
    article_id
  from translations
  inner join calculations on 1=1
  inner join history on history.translation_id = translations.id
  where change_at > '2022-12-08'
  group by article_id, avg_total_count_translations
  having count(article_id) > avg_total_count_translations / 2
)
select 
  distinct sorted_translations.article_id, display_name, login, title
from users
inner join history on history.change_by = users.id
inner join translations on history.translation_id = translations.id
inner join sorted_translations on sorted_translations.article_id = translations.article_id
where 
  history.type = 'create'

```

ответ:

| article_id integer | display_name text |                     login text                     |                                                                       title text                                                                      |                       views integer                      |       |
|:------------------:|:-----------------:|:--------------------------------------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------:|:--------------------------------------------------------:|-------|
|          1         | 3                 | Anthony Rogers                                     | bank.juliehartman@gmail.com                                                                                                                           | Day remember investment since somebody forward.          | 99978 |
|          2         | 3                 | Zachary Miller                                     | design.michelleross@gmail.com                                                                                                                         | Responsibility nor data movement think cup.              | 99762 |
|          3         | 4                 | Krystal Hart                                       | run.rodriguezmelanie@gmail.com                                                                                                                        | Tv public subject article left step.                     | 99303 |
|          4         | 5                 | Aaron Warren                                       | newspaper.brownmelissa@hotmail.com                                                                                                                    | Plant focus successful agreement decade buy.             | 99179 |
|          5         | 5                 | Anthony Smith                                      | either.ntaylor@hotmail.com                                                                                                                            | International prepare else all child actually.           | 99133 |
|          6         | 5                 | Brandi Hoffman                                     | attack.santiagodeborah@gmail.com                                                                                                                      | Officer admit hand short marriage tonight.               | 99092 |
|          7         | 5                 | Carolyn Brown                                      | couple.rhonda33@gmail.com                                                                                                                             | International prepare else all child actually.           | 99080 |
|          8         | 5                 | Michael Mccoy                                      | bank.waguilar@hotmail.com                                                                                                                             | Dinner long book bad policy central.                     | 98830 |
|          9         | 5                 | Ronald Perez                                       | other.crawfordbarbara@yahoo.com                                                                                                                       | Raise them interview recently court listen.              | 98554 |
|         10         | 6                 | Mike Johnston                                      | compare.karlascott@yahoo.com                                                                                                                          | Kind value poor any than choice.                         | 98540 |
## 5.4. вывести промежуток вермени между созданием и последним изменением статьи, если изменение есть, если же нет, вывести в соотвествующей ячейках нулл

запрос:
```sql
select 
  translation_id,
  min(change_at) as created_at,
  max(change_at) as last_updated_at,
  (case when tstzrange(min(change_at), max(change_at)) = 'empty' then null
      else max(change_at) - min(change_at)
      end) as interval_u_c
from history
where type in ('create', 'update')
group by translation_id
limit 100;

-- далее посчитать минимальную, максимальную и среднию
-- длину интервала для предыдущего запроса

with intervals as ( 
  select 
    translation_id,
    min(change_at) as created_at,
    max(change_at) as last_updated_at,
    (case when tstzrange(min(change_at), max(change_at)) = 'empty' then null
        else max(change_at) - min(change_at)
        end) as interval_u_c
  from history
  where type in ('create', 'update')
  group by translation_id
  limit 100
)
select 
  min(interval_u_c),
  max(interval_u_c),
  avg(interval_u_c)
from intervals;
```

ответ:

| translation_id integer | created_at timestamp without time zone |        last_updated_at timestamp without time zone       |                                                                 interval_u_c interval                                                                 |                       views integer                      |       |
|:----------------------:|:--------------------------------------:|:--------------------------------------------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------:|:--------------------------------------------------------:|-------|
|            1           | 69906                                  | Sun Dec 04 2022 22:12:04 GMT+0300 (Moscow Standard Time) | Sun Dec 18 2022 06:08:49 GMT+0300 (Moscow Standard Time)                                                                                              | P13DT7H56M45S                                            | 99978 |
|            2           | 47051                                  | Fri Dec 02 2022 01:09:04 GMT+0300 (Moscow Standard Time) | Mon Dec 12 2022 18:31:57 GMT+0300 (Moscow Standard Time)                                                                                              | P10DT17H22M53S                                           | 99762 |
|            3           | 89714                                  | Tue Dec 13 2022 09:27:29 GMT+0300 (Moscow Standard Time) | Tue Dec 13 2022 09:27:29 GMT+0300 (Moscow Standard Time)                                                                                              | null                                                     | 99303 |
|            4           | 5468                                   | Wed Dec 14 2022 03:20:49 GMT+0300 (Moscow Standard Time) | Wed Dec 14 2022 03:20:49 GMT+0300 (Moscow Standard Time)                                                                                              | null                                                     | 99179 |
|            5           | 40694                                  | Thu Dec 15 2022 03:40:43 GMT+0300 (Moscow Standard Time) | Thu Dec 15 2022 03:40:43 GMT+0300 (Moscow Standard Time)                                                                                              | null                                                     | 99133 |
|            6           | 47114                                  | Tue Dec 13 2022 14:12:00 GMT+0300 (Moscow Standard Time) | Sun Dec 18 2022 09:32:30 GMT+0300 (Moscow Standard Time)                                                                                              | P4DT19H20M30S                                            | 99092 |
|            7           | 54304                                  | Mon Dec 19 2022 11:29:37 GMT+0300 (Moscow Standard Time) | Mon Dec 19 2022 11:29:37 GMT+0300 (Moscow Standard Time)                                                                                              | null                                                     | 99080 |
|            8           | 26770                                  | Mon Dec 05 2022 21:55:59 GMT+0300 (Moscow Standard Time) | Mon Dec 05 2022 21:55:59 GMT+0300 (Moscow Standard Time)                                                                                              | null                                                     | 98830 |
|            9           | 5697                                   | Sun Dec 18 2022 08:53:16 GMT+0300 (Moscow Standard Time) | Sun Dec 18 2022 08:53:16 GMT+0300 (Moscow Standard Time)                                                                                              | null                                                     | 98554 |
|           10           | 41011                                  | Mon Dec 05 2022 03:31:17 GMT+0300 (Moscow Standard Time) | Sat Dec 10 2022 20:52:22 GMT+0300 (Moscow Standard Time)                                                                                              | P5DT17H21M5S                                             | 98540 |


## 5.5 вывести топ 10 пользователей по количеству подписок на статьи, просмотры которых превышают средний показатель всех просмотров статей

запрос:
```sql
with counts as (
  select 
    avg(views) as avg_views
  from translations
)
select 
  display_name,
  email,
  count(watchers.article_id)
from users
inner join watchers on watchers.user_id = users.id
inner join translations on watchers.article_id = translations.id
inner join counts on 1 = 1
where views > avg_views
group by display_name, email
order by count(watchers.article_id) desc
limit 10
```

ответ:

| display_name text |     email text    |                    count bigint                    |                                                                 interval_u_c interval                                                                 |                       views integer                      |       |
|:-----------------:|:-----------------:|:--------------------------------------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------:|:--------------------------------------------------------:|-------|
|         1         | Rebecca Blackwell | davidmanning@yahoo.com                             | 4                                                                                                                                                     | P13DT7H56M45S                                            | 99978 |
|         2         | Leslie Cruz       | jmason@gmail.com                                   | 3                                                                                                                                                     | P10DT17H22M53S                                           | 99762 |
|         3         | Amy Whitehead     | watsondennis@yahoo.com                             | 3                                                                                                                                                     | null                                                     | 99303 |
|         4         | Brian Scott       | lynnamber@gmail.com                                | 3                                                                                                                                                     | null                                                     | 99179 |
|         5         | Amanda Pearson    | paul98@yahoo.com                                   | 3                                                                                                                                                     | null                                                     | 99133 |
|         6         | Joyce Schmidt     | matthewmartinez@yahoo.com                          | 3                                                                                                                                                     | P4DT19H20M30S                                            | 99092 |
|         7         | Bradley Erickson  | ehernandez@yahoo.com                               | 3                                                                                                                                                     | null                                                     | 99080 |
|         8         | Andrea Boyd       | sarah83@hotmail.com                                | 3                                                                                                                                                     | null                                                     | 98830 |
|         9         | Alexander Stanley | murphyeddie@hotmail.com                            | 3                                                                                                                                                     | null                                                     | 98554 |
|         10        | James Nash        | estesstephanie@gmail.com                           | 3                                                                                                                                                     | P5DT17H21M5S                                             | 98540 |

## 5.6. вывести одну случайную из 100 статей, ранжируемых по количеству просмотров принадлежащих секциям, уровень вложенности которых больше 2


запрос:
```sql
select
  title,
  short_description,
  level,
  translations.views
from translations
inner join articles on articles.id = translations.article_id
inner join sections on sections.id = articles.section
where level > 2
ORDER BY translations.views DESC
limit 100
```

ответ:

| title text |           short_description text          |                                                                     level integer                                                                     |                                                                     views integer                                                                     |                       views integer                      |       |
|:----------:|:-----------------------------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------:|:--------------------------------------------------------:|-------|
|      1     | We people factor a study number.          | Traditional different bill sort. Understand kitchen sure. Ever group mean tree agency per total.                                                      | 3                                                                                                                                                     | 100000                                                   | 99978 |
|      2     | Art create example family consider table. | Citizen main raise away home heart. Big game there wait until front move. Relate why voice soldier southern accept continue. Everybody too detail ye… | 3                                                                                                                                                     | 99999                                                    | 99762 |
|      3     | Per final arm event reduce today.         | Front usually responsibility within. Away color thank affect. Shake plant foreign show building.                                                      | 4                                                                                                                                                     | 99999                                                    | 99303 |
|      4     | Where official fast eye while sort.       | Catch language center break. Past ten force relationship them anything feeling. Wonder common as tough compare hour.                                  | 3                                                                                                                                                     | 99995                                                    | 99179 |
|      5     | Let rest hope marriage use leader.        | Laugh impact economic. Sound add page crime pattern cover. Network power strategy dinner concern. Woman standard nature push my become. Be event alr… | 3                                                                                                                                                     | 99995                                                    | 99133 |
|      6     | So station level western more college.    | Treat reduce claim themselves success central society. Which individual but situation always Congress. Owner left pick six account whether tradition… | 3                                                                                                                                                     | 99992                                                    | 99092 |
|      7     | His hotel health Mrs look exactly.        | Loss chair history film. Enough lead when occur radio evening apply. Include note ground prevent. He western because similar hotel among ability. Cl… | 4                                                                                                                                                     | 99992                                                    | 99080 |
|      8     | Edge force indeed hundred total card.     | Point star hope machine form feeling maintain. Teach believe even animal reflect theory. Anything about gun. Similar suggest relationship few. First… | 3                                                                                                                                                     | 99992                                                    | 98830 |
|      9     | Congress economic free hold phone add.    | Effect material brother benefit best. Present including popular claim meeting there. Fire soon wish necessary how. Standard front knowledge still. O… | 4                                                                                                                                                     | 99991                                                    | 98554 |
|     10     | Work meeting discussion item know should. | Father with any fill a organization. Then against senior over eye. Church radio early discover onto surface plan. Response treatment partner body ha… | 4                                                                                                                                                     | 99990                                                    | 98540 |

## 5.7. вывести примереное время скачивания всех индексируемых статей, созданных позже 8 декабаря 2022 из секции, уровень вложенности которых равный 3


запрос:
```sql
-- средняя скорость скачивания 2Мбит/с
select
  article_id as id,
  byte_length,
  sum(byte_length) / 512 as time_in_seconds
from translations
inner join articles on articles.id = translations.article_id
inner join history on history.translation_id = translations.id
inner join sections on articles.section = sections.id
where 
  change_at > '2022-12-8' and
  sections.level = 3
group by article_id, byte_length
```

ответ:

|    | id integer |                 byte_length integer                |                                                                 time_in_seconds bigint                                                                |                       views integer                      |       |
|:--:|:----------:|:--------------------------------------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------------:|:--------------------------------------------------------:|-------|
|  1 | 349        | 5680                                               | 11                                                                                                                                                    | 100000                                                   | 99978 |
|  2 | 2245       | 7088                                               | 27                                                                                                                                                    | 99999                                                    | 99762 |
|  3 | 731        | 5312                                               | 10                                                                                                                                                    | 99999                                                    | 99303 |
|  4 | 7316       | 11800                                              | 46                                                                                                                                                    | 99995                                                    | 99179 |
|  5 | 3740       | 6240                                               | 24                                                                                                                                                    | 99995                                                    | 99133 |
|  6 | 7551       | 10728                                              | 20                                                                                                                                                    | 99992                                                    | 99092 |
|  7 | 3748       | 10888                                              | 42                                                                                                                                                    | 99992                                                    | 99080 |
|  8 | 7242       | 9136                                               | 17                                                                                                                                                    | 99992                                                    | 98830 |
|  9 | 2719       | 8592                                               | 33                                                                                                                                                    | 99991                                                    | 98554 |
| 10 | 1595       | 12944                                              | 25                                                                                                                                                    | 99990                                                    | 98540 |

# 6. Дополнительные запросы:

## 6.1. Задача: Найти всех пользователей, которые ТОЛЬКО редактировали статьи

запрос:
```sql
with only_update as (
  select 
    change_by
  from history
  except
  select
    change_by
  from history
  where type in ('create', 'delete')
)
select
  id,
  display_name,
  login,
  email
from users
inner join only_update on only_update.change_by = users.id
order by id
```

ответ:

| id integer | display_name text |        login text       |           email text          |                          |
|:----------:|:-----------------:|:-----------------------:|:-----------------------------:|--------------------------|
|      1     | 684               | Joshua Thomas           | treat.pgonzalez@hotmail.com   | pgonzalez@hotmail.com    |
|      2     | 906               | Michael Hill            | develop.joebrewer@gmail.com   | joebrewer@gmail.com      |
|      3     | 4404              | Mrs. Alexandra Matthews | present.randy92@gmail.com     | randy92@gmail.com        |
|      4     | 4632              | Michele Brown           | miss.christineshaw@yahoo.com  | christineshaw@yahoo.com  |
|      5     | 5547              | James Lewis             | reason.jasminbyrd@gmail.com   | jasminbyrd@gmail.com     |
|      6     | 9240              | Brandon Richards        | wear.josebautista@hotmail.com | josebautista@hotmail.com |

## 6.2. Найти всех пользователей, которые ТОЛЬКО редактировали статьи

-- Задача: среди этих пользоватей найти тех, кто редактировал ровно одну статью

запрос:
```sql
with only_update as (
  select 
    change_by
  from history
  except
  select
    change_by
  from history
  where type in ('create', 'delete')
)
select 
  users.id as id,
  display_name,
  login,
  email
from history
inner join only_update on history.change_by = only_update.change_by
inner join users on users.id = history.change_by
group by history.change_by, users.id
having count(distinct translation_id) = 1
order by history.change_by
```

ответ:

| id integer | display_name text |        login text       |           email text          |                          |   |
|:----------:|:-----------------:|:-----------------------:|:-----------------------------:|--------------------------|---|
|      1     | 4404              | Mrs. Alexandra Matthews | present.randy92@gmail.com     | randy92@gmail.com        |   |
|      2     | 4632              | Michele Brown           | miss.christineshaw@yahoo.com  | christineshaw@yahoo.com  |   |
|      3     | 9240              | Brandon Richards        | wear.josebautista@hotmail.com | josebautista@hotmail.com |   |

## 6.3. Задача: Сделать merged поиск для дата-колонок переводов

Пояснение: пусть пользователь задал регулярку
ему нужно отдать все строки, в колонках которых есть хотя бы один матч

запрос:
```sql
-- OR
with const as (
  select '%(C|c)ould%' as regexp
)
select
  id,
  data,
  title,
  short_description
from translations
inner join const on 1 = 1
where
  title similar to const.regexp or
  short_description similar to const.regexp or
  data similar to const.regexp;


-- AND
with const as (
  select '%(C|c)ould%' as regexp
)
select
  id,
  data,
  title,
  short_description
from translations
inner join const on 1 = 1
where
  title similar to const.regexp and
  short_description similar to const.regexp and
  data similar to const.regexp;
```

ответ:

| id integer | data text |                                                                   title text                                                                  |             short_description text            |                                                                                                                                                       |   |
|:----------:|:---------:|:---------------------------------------------------------------------------------------------------------------------------------------------:|:---------------------------------------------:|-------------------------------------------------------------------------------------------------------------------------------------------------------|---|
|      1     | 72464     | <DefaultTemplate>Size each front really become poor. Bill natural government line process better. Imagine community along relationship. That… | Could sense operation reason field seat.      | Even there able fine. Partner certainly even another beat dark. Development serve executive us measure article. Machine training get include. Could … |   |
|      2     | 75146     | <DefaultTemplate>School red international. Thousand bed myself. Treat writer happy. Fill person kitchen price walk happen. Require consumer … | East professional court thing anything could. | Step situation staff leader city success. Personal hand allow sell. If same people visit paper either. Could garden price order president picture.    |   |
|      3     | 2767      | <DefaultTemplate>Cost detail never result onto message. Source others police physical while. Center bad water strong leader thus. Model cost… | Care month bank hour none real.               | Place however ball cover. In item today impact. Else air peace focus increase new front effect. Decision reach surface business. Write interest mana… |   |
|      4     | 2779      | <DefaultTemplate>Weight resource development modern. Surface simple theory toward. Rock those individual dinner south. Social face price bec… | Off point measure very everybody hit.         | Could yet table establish senior improve. Free stop fish president company drop. Movement music purpose activity class. Chair thus weight this. Tell… |   |